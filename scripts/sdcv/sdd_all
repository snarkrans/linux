#!/usr/bin/env bash
# def-tui â€” Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ñ‡Ğ¸Ğº Ğ½Ğ° sdcv + trans + gum (Ğ²ÑĞµ ÑĞ»Ğ¾Ğ²Ğ°Ñ€Ğ¸)

history="$HOME/data/soft/stardict-dicts"
mkdir -p "$history"

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
for cmd in sdcv trans gum; do
  command -v "$cmd" >/dev/null 2>&1 || {
    echo "ĞÑˆĞ¸Ğ±ĞºĞ°: ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ° '$cmd' Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°."; exit 1;
  }
done

# ğŸ”¹ ĞœĞµĞ½Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ°
choice=$(gum choose \
  "enâ†’ru â€” English â†’ Ğ ÑƒÑÑĞºĞ¸Ğ¹" \
  "ruâ†’en â€” Ğ ÑƒÑÑĞºĞ¸Ğ¹ â†’ English" \
  "itâ†’ru â€” Italiano â†’ Ğ ÑƒÑÑĞºĞ¸Ğ¹" \
  "ruâ†’it â€” Ğ ÑƒÑÑĞºĞ¸Ğ¹ â†’ Italiano" \
  "deâ†’ru â€” Deutsch â†’ Ğ ÑƒÑÑĞºĞ¸Ğ¹" \
  "ruâ†’de â€” Ğ ÑƒÑÑĞºĞ¸Ğ¹ â†’ Deutsch" \
  "ukâ†’ru â€” Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ° â†’ Ğ ÑƒÑÑĞºĞ¸Ğ¹" \
  "ruâ†’uk â€” Ğ ÑƒÑÑĞºĞ¸Ğ¹ â†’ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°" \
  "exit â€” Ğ’Ñ‹Ñ…Ğ¾Ğ´" \
  --header "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ°:")

dir=$(echo "$choice" | awk '{print $1}')  # Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, enâ†’ru
src=${dir%%â†’*}   # ÑĞ·Ñ‹Ğº Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ°
dst=${dir##*â†’}   # ÑĞ·Ñ‹Ğº Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ°

# ğŸ”¹ Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ° (Ğ²ÑĞµ ÑĞ»Ğ¾Ğ²Ğ°Ñ€Ğ¸)
translate_lang() {
  local src="$1" dst="$2" hist_file="$3"
  gum style --border double --bold --foreground 212 "=== $src â†’ $dst ==="

  while true; do
    var=$(gum input --placeholder "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ (q â€” Ğ²Ñ‹Ñ…Ğ¾Ğ´)")
    [[ -z "$var" || "$var" == "q" ]] && break

    # ĞĞ½Ğ»Ğ°Ğ¹Ğ½ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ (ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹) Ğ¸ Ğ¾Ğ·Ğ²ÑƒÑ‡ĞºĞ°
    trans "$src:$dst" -speak "$var" >/dev/null 2>&1
    local short_trans
    short_trans=$(trans -brief "$src:$dst" "$var")
    printf "%s\t%s\n" "$var" "$short_trans" >> "$hist_file"

    # Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ°Ñ€Ğ¸ (Ğ²ÑĞµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ)
    sdcv -n --utf8-output --color "$var" | less -RX

    clear
  done
}

# ğŸ”¹ ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
case "$dir" in
  enâ†’ru) translate_lang en ru "$history/en.txt" ;;
  ruâ†’en) translate_lang ru en "$history/en.txt" ;;
  itâ†’ru) translate_lang it ru "$history/it.txt" ;;
  ruâ†’it) translate_lang ru it "$history/it.txt" ;;
  deâ†’ru) translate_lang de ru "$history/de.txt" ;;
  ruâ†’de) translate_lang ru de "$history/de.txt" ;;
  ukâ†’ru) translate_lang uk ru "$history/uk.txt" ;;
  ruâ†’uk) translate_lang ru uk "$history/uk.txt" ;;
  exit) gum style --foreground 245 "Ğ’Ñ‹Ñ…Ğ¾Ğ´ ğŸ‘‹"; exit 0 ;;
esac

