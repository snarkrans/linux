#!/usr/bin/env bash
# def-tui ‚Äî –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ –Ω–∞ sdcv + trans + gum

history="$HOME/data/soft/stardict-dicts"
mkdir -p "$history"

for cmd in sdcv trans gum fzf; do
  command -v "$cmd" >/dev/null 2>&1 || {
    echo "–û—à–∏–±–∫–∞: —É—Ç–∏–ª–∏—Ç–∞ '$cmd' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."; exit 1;
  }
done

# üîπ –ï–¥–∏–Ω–æ–µ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞
choice=$(gum choose \
  "en‚Üíru ‚Äî English ‚Üí –†—É—Å—Å–∫–∏–π" \
  "ru‚Üíen ‚Äî –†—É—Å—Å–∫–∏–π ‚Üí English" \
  "it‚Üíru ‚Äî Italiano ‚Üí –†—É—Å—Å–∫–∏–π" \
  "ru‚Üíit ‚Äî –†—É—Å—Å–∫–∏–π ‚Üí Italiano" \
  "de‚Üíru ‚Äî Deutsch ‚Üí –†—É—Å—Å–∫–∏–π" \
  "ru‚Üíde ‚Äî –†—É—Å—Å–∫–∏–π ‚Üí Deutsch" \
  "uk‚Üíru ‚Äî –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ ‚Üí –†—É—Å—Å–∫–∏–π" \
  "ru‚Üíuk ‚Äî –†—É—Å—Å–∫–∏–π ‚Üí –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞" \
  "all ‚Äî –í—Å–µ —Å–ª–æ–≤–∞—Ä–∏" \
  "exit ‚Äî –í—ã—Ö–æ–¥" \
  --header "–í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞:")

dir=$(echo "$choice" | awk '{print $1}')  # –Ω–∞–ø—Ä–∏–º–µ—Ä, en‚Üíru
src=${dir%%‚Üí*}   # —è–∑—ã–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
dst=${dir##*‚Üí}   # —è–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∞

# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
translate_lang() {
  local src="$1" dst="$2" dict="$3" history_file="$4"
  gum style --border double --bold --foreground 212 "=== $src ‚Üí $dst ==="

  while true; do
    var=$(gum input --placeholder "–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ (q ‚Äî –≤—ã—Ö–æ–¥)")
    [[ -z "$var" || "$var" == "q" ]] && break

    trans "$src:$dst" -speak "$var" >/dev/null 2>&1
    printf "%s\t%s\n" "$var" "$(trans -brief "$src:$dst" "$var")" >> "$history_file"
    sdcv -ucn "$dict" --utf8-output --color "$var" | less -RX
    clear
  done
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
case "$dir" in
  en‚Üíru) translate_lang en ru "LingvoUniversal (En-Ru)" "$history/en.txt" ;;
  ru‚Üíen) translate_lang ru en "LingvoUniversal (Ru-En)" "$history/en.txt" ;;
  it‚Üíru) translate_lang it ru "Universal (It-Ru)" "$history/it.txt" ;;
  ru‚Üíit) translate_lang ru it "Universal (Ru-It)" "$history/it.txt" ;;
  de‚Üíru) translate_lang de ru "Universal (De-Ru)" "$history/de.txt" ;;
  ru‚Üíde) translate_lang ru de "Universal (Ru-De)" "$history/de.txt" ;;
  uk‚Üíru) translate_lang uk ru "slovnyk_uk-ru" "$history/uk.txt" ;;
  ru‚Üíuk) translate_lang ru uk "slovnyk_ru_uk" "$history/uk.txt" ;;
  all)
    dict=$(sdcv -l | fzf | cut -d" " -f1,2)
    while true; do
      var=$(gum input --placeholder "–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ (q ‚Äî –≤—ã—Ö–æ–¥)")
      [[ -z "$var" || "$var" == "q" ]] && break
      sdcv -ucn "$dict" --utf8-output --color "$var" | less -RX
      clear
    done
    ;;
  exit) gum style --foreground 245 "–í—ã—Ö–æ–¥ üëã"; exit 0 ;;
esac
